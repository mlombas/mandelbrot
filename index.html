<!--Main page, for the visualization-->
<html>
    <head>
        <title>Mandelbrot</title>
        <style>
            body {
                text-align: center;
            }

            canvas {
                margin: auto;

                border-color: black;
                border-width: 3%;
                border-style: dashed;

                width: 100vh;
                height: 75vh;
            }

            input[type=range] {
                width: 90vw;
            }
        </style>
    </head>
    <body>
        <canvas></canvas>
        <h3># of iterations, more is slower</h3>
        <p>Current: <span id="iterNum">50</span></p>
        <input id="iterSlide" type="range" min="0" max="1000" value="50">
        <h3>Resolution of image, more is slower</h3>
        <p>Current: <span id="resNum">480</span></p>
        <input id="resSlide" type="range" min="10" max="2000" value="480">
        <script>
            let dimension = 480,
                scale = 1, mandelScale = 1,
                center = {x: 0, y: 0}, mandelCenter = {x: 0, y: 0},
                maxIter = 50,
                tBetweenDrawings = 100;

            let canvas = document.querySelector("canvas");
            canvas.width = 2000;
            canvas.height = 1500;
            let mandelCanvas = document.createElement("canvas"),
                mandelCtx = mandelCanvas.getContext("2d");
            mandelCanvas.width = canvas.width;
            mandelCanvas.height = canvas.height;

            function drawMandelbrot(dimension, pos, scale, maxIter) {
                let oldMandelbrot = {
                    center: Object.assign({}, mandelCenter),
                    scale: mandelScale
                }

                new Promise((resolve, reject) => {
                    drawMandelbrot.mandelbrotWorker.onmessage = msg => {
                        let preCanvas = document.createElement("canvas");
                        preCanvas.width = dimension;
                        preCanvas.height = dimension;
                        let preCtx = preCanvas.getContext("2d");

                        let img = msg.data;
                        preCtx.putImageData(img, 0, 0);

                        resolve(preCanvas);
                    };
                    drawMandelbrot.mandelbrotWorker.postMessage({dimension: dimension, center: pos, scale: scale, maxIter: maxIter});
                })
                .then(preCanvas => {
                    mandelCenter = {x: mandelCenter.x - oldMandelbrot.center.x, y: mandelCenter.y - oldMandelbrot.center.y}

                    mandelScale = 1; //Set scale as difference
                    mandelScale *= oldMandelbrot.scale;
                    mandelCenter.x *= oldMandelbrot.scale;
                    mandelCenter.y *= oldMandelbrot.scale;

                    mandelCtx.drawImage(preCanvas, 0, 0, mandelCanvas.width, mandelCanvas.height);
                });
            }
            drawMandelbrot.mandelbrotWorker = new window.Worker("mandelbrot.js");

            let redrawInterval = setInterval(() => {drawMandelbrot(dimension, center, scale, maxIter); console.log("d")}, tBetweenDrawings);
            canvas.onmousewheel = evt => {
                let scaleDelta = 1 + evt.wheelDelta / 120 * 0.1;
                scale *= scaleDelta; //also scale center
                center.x *= scaleDelta;
                center.y *= scaleDelta;

                mandelScale *= scaleDelta;
                mandelCenter.x *= scaleDelta;
                mandelCenter.y *= scaleDelta;
            }

            let lastPos;
            let mouseIsDown = false;
            canvas.onmousedown = () => mouseIsDown = true;
            canvas.onmouseup = canvas.onmouseout = () => { mouseIsDown = false; lastPos = undefined; }
            canvas.onmousemove = evt => {
                if(mouseIsDown) {
                    let dx = (evt.clientX - lastPos.x) * canvas.width/canvas.clientWidth,
                        dy = (evt.clientY - lastPos.y) * canvas.height/canvas.clientHeight;
                    mandelCenter = {x: mandelCenter.x + dx, y: mandelCenter.y + dy};
                    center = {x: center.x - dx * dimension/canvas.width, y: center.y - dy * dimension/canvas.height};
                }
                lastPos = {x: evt.clientX, y: evt.clientY};
            }

            document.querySelector("#iterSlide").oninput = evt => document.querySelector("#iterNum").innerHTML = evt.target.value;
            document.querySelector("#iterSlide").onmouseup = evt => {
                document.querySelector("#iterNum").textContent = maxIter = evt.target.value;
                drawMandelbrot(dimension, center, scale, maxIter);
            }
            document.querySelector("#resSlide").oninput = evt => document.querySelector("#resNum").innerHTML = evt.target.value;
            document.querySelector("#resSlide").onmouseup = evt => {
                document.querySelector("#resNum").textContent = dimension = evt.target.value;
                drawMandelbrot(dimension, center, scale, maxIter);
            }
            drawMandelbrot(dimension, center, scale, maxIter);

            function drawToMainCalvas() {
                let ctx = canvas.getContext("2d");
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.save();
                ctx.translate(mandelCenter.x + canvas.width/2, mandelCenter.y + canvas.height/2);
                ctx.scale(mandelScale, mandelScale);
                ctx.drawImage(mandelCanvas, -mandelCanvas.width/2, -mandelCanvas.height/2);
                ctx.restore();

                requestAnimationFrame(drawToMainCalvas);
            }
            requestAnimationFrame(drawToMainCalvas);
        </script>
    </body>
</html>